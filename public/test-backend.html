<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RelEye - Backend Test & Reset</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #88E5D7;
            margin-bottom: 10px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .section h2 {
            color: #88E5D7;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .button {
            padding: 12px 24px;
            background: #88E5D7;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            background: #a0f0e0;
            transform: translateY(-2px);
        }

        .button.danger {
            background: #ff4444;
            color: #fff;
        }

        .button.danger:hover {
            background: #ff6666;
        }

        .result {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .result.success {
            border-color: #88E5D7;
            color: #88E5D7;
        }

        .result.error {
            border-color: #ff4444;
            color: #ff6666;
        }

        .warning-box {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: #ff4444;
            margin-bottom: 10px;
        }

        .info {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(136, 229, 215, 0.3);
            border-radius: 50%;
            border-top-color: #88E5D7;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RelEye Backend Test & Reset</h1>
            <p style="color: rgba(255, 255, 255, 0.6);">Diagnostic and reset utility for the backend API</p>
        </div>

        <div class="section">
            <h2>1. Backend Status</h2>
            <p class="info">Test if the backend API is accessible and responding correctly.</p>
            <button class="button" onclick="testBackend()">Test Backend Connection</button>
            <button class="button" onclick="checkFirstTime()">Check First-Time Status</button>
            <div id="backend-result"></div>
        </div>

        <div class="section">
            <h2>2. Database Reset</h2>
            <div class="warning-box">
                <h3>‚ö†Ô∏è Warning: This will delete ALL user data</h3>
                <ul style="padding-left: 20px; color: rgba(255, 255, 255, 0.8);">
                    <li>All user accounts will be deleted</li>
                    <li>All pending invitations will be deleted</li>
                    <li>You will need to create a new admin account</li>
                    <li>Your workspace files will NOT be affected</li>
                </ul>
            </div>
            <p class="info">This will call the backend API to reset all user credentials and authentication data.</p>
            <button class="button danger" onclick="resetDatabase()">üî¥ Reset Database Now</button>
            <div id="reset-result"></div>
        </div>

        <div class="section">
            <h2>3. LocalStorage Cleanup</h2>
            <p class="info">Clear all local session data stored in your browser.</p>
            <button class="button" onclick="clearLocalStorage()">Clear LocalStorage</button>
            <button class="button" onclick="viewLocalStorage()">View LocalStorage</button>
            <div id="storage-result"></div>
        </div>

        <div class="section">
            <h2>4. Complete Reset & Restart</h2>
            <p class="info">This will reset the database AND clear local storage, then redirect you to the first-time setup.</p>
            <button class="button danger" onclick="completeReset()">üî¥ Complete Reset & Restart</button>
            <div id="complete-result"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.protocol + '//' + window.location.host + '/api';

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = 'result ' + type;
            element.style.display = 'block';
        }

        function showLoading(elementId) {
            showResult(elementId, 'Loading...<div class="loading"></div>', 'info');
        }

        async function testBackend() {
            showLoading('backend-result');
            
            try {
                const response = await fetch(API_URL + '/health', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('backend-result', 
                        '‚úÖ Backend is connected!\n\n' + JSON.stringify(data, null, 2),
                        'success'
                    );
                } else {
                    showResult('backend-result', 
                        '‚ùå Backend returned error:\n\n' + JSON.stringify(data, null, 2),
                        'error'
                    );
                }
            } catch (error) {
                showResult('backend-result', 
                    '‚ùå Failed to connect to backend:\n\n' + error.message,
                    'error'
                );
            }
        }

        async function checkFirstTime() {
            showLoading('backend-result');
            
            try {
                const response = await fetch(API_URL + '/auth/first-time', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data.isFirstTime ? 
                        '‚úÖ No admin exists - ready for first-time setup' :
                        '‚ö†Ô∏è Admin already exists - you need to reset or login';
                    
                    showResult('backend-result', 
                        status + '\n\n' + JSON.stringify(data, null, 2),
                        data.data.isFirstTime ? 'success' : 'error'
                    );
                } else {
                    showResult('backend-result', 
                        '‚ùå Error checking status:\n\n' + JSON.stringify(data, null, 2),
                        'error'
                    );
                }
            } catch (error) {
                showResult('backend-result', 
                    '‚ùå Failed to check first-time status:\n\n' + error.message,
                    'error'
                );
            }
        }

        async function resetDatabase() {
            if (!confirm('Are you ABSOLUTELY SURE you want to delete all user data?\n\nThis cannot be undone!')) {
                return;
            }

            if (!confirm('Final confirmation: Delete all users and credentials?')) {
                return;
            }

            showLoading('reset-result');
            
            try {
                const response = await fetch(API_URL + '/auth/reset-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('reset-result', 
                        '‚úÖ Database reset successful!\n\n' + 
                        'All user data has been deleted.\n' +
                        'You can now create a new admin account.\n\n' +
                        JSON.stringify(data, null, 2),
                        'success'
                    );
                } else {
                    showResult('reset-result', 
                        '‚ùå Reset failed:\n\n' + JSON.stringify(data, null, 2),
                        'error'
                    );
                }
            } catch (error) {
                showResult('reset-result', 
                    '‚ùå Failed to reset database:\n\n' + error.message,
                    'error'
                );
            }
        }

        function clearLocalStorage() {
            try {
                localStorage.clear();
                showResult('storage-result', 
                    '‚úÖ LocalStorage cleared successfully!\n\nAll local session data has been removed.',
                    'success'
                );
            } catch (error) {
                showResult('storage-result', 
                    '‚ùå Failed to clear localStorage:\n\n' + error.message,
                    'error'
                );
            }
        }

        function viewLocalStorage() {
            try {
                const items = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    items[key] = localStorage.getItem(key);
                }
                
                if (Object.keys(items).length === 0) {
                    showResult('storage-result', 
                        'LocalStorage is empty.',
                        'info'
                    );
                } else {
                    showResult('storage-result', 
                        'LocalStorage contents:\n\n' + JSON.stringify(items, null, 2),
                        'info'
                    );
                }
            } catch (error) {
                showResult('storage-result', 
                    '‚ùå Failed to read localStorage:\n\n' + error.message,
                    'error'
                );
            }
        }

        async function completeReset() {
            if (!confirm('COMPLETE RESET:\n\n' +
                        '1. Delete all users from database\n' +
                        '2. Clear all local session data\n' +
                        '3. Redirect to first-time setup\n\n' +
                        'Are you sure?')) {
                return;
            }

            showLoading('complete-result');
            
            try {
                const response = await fetch(API_URL + '/auth/reset-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.clear();
                    
                    showResult('complete-result', 
                        '‚úÖ Complete reset successful!\n\n' +
                        'Database reset: ‚úì\n' +
                        'LocalStorage cleared: ‚úì\n\n' +
                        'Redirecting to first-time setup in 3 seconds...',
                        'success'
                    );
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showResult('complete-result', 
                        '‚ùå Reset failed:\n\n' + JSON.stringify(data, null, 2),
                        'error'
                    );
                }
            } catch (error) {
                showResult('complete-result', 
                    '‚ùå Failed to complete reset:\n\n' + error.message,
                    'error'
                );
            }
        }

        window.onload = function() {
            testBackend();
        };
    </script>
</body>
</html>
