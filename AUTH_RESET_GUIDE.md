# Authentication Reset & Diagnostics Guide

## Problem: Can't Access First-Time Setup After Reset

If you're seeing the normal login screen instead of the first-time admin setup screen after running reset.html or test-backend.html, this guide will help you troubleshoot and fix the issue.

## Understanding the Problem

The authentication system has three main states:

1. **First-Time Setup** - No admin exists, you need to create the first admin account
2. **Login Required** - Admin exists, you need to log in with credentials
3. **Logged In** - You're authenticated and can use the app

The issue occurs when:
- You reset the database using reset.html or test-backend.html
- The backend successfully deletes all users
- But the app still thinks an admin exists (shows normal login instead of first-time setup)

## Root Causes

This can happen due to:

1. **Backend Not Responding** - The `/api/auth/first-time` endpoint isn't working
2. **Caching Issues** - Browser or backend is returning cached responses
3. **Database Not Resetting** - The reset endpoint isn't actually deleting users
4. **Session Persistence** - Old session tokens are interfering

## Solution Steps

### Step 1: Use the Diagnostics Tool

Visit the diagnostics page to check the system status:

```
https://releye.boestad.com/?diagnostics=true
```

Or click "API Connection Diagnostics" on the login page.

The diagnostics will show:
- ✅ Backend API is responding
- ✅/⚠️ First-time setup status
- ⚠️ Current user session status
- ✅ LocalStorage contents

### Step 2: Clear Everything and Reset

If diagnostics show the backend is working but still reports `isFirstTime: false`, do this:

1. **Visit test-backend.html:**
   ```
   https://releye.boestad.com/test-backend.html
   ```

2. **Click "Complete Reset & Restart"** in Section 4
   - This will reset the database
   - Clear localStorage
   - Clear sessionStorage
   - Redirect you with `?reset=true` parameter

3. **The app should now show first-time setup**

### Step 3: Manual Reset (If Automatic Doesn't Work)

If the automatic reset doesn't work:

1. **Open Browser DevTools** (F12)

2. **Go to Console Tab**

3. **Run these commands:**
   ```javascript
   // Clear all local storage
   localStorage.clear()
   sessionStorage.clear()
   
   // Verify the backend status
   fetch('https://releye.boestad.com/api/auth/first-time', {credentials: 'include'})
     .then(r => r.json())
     .then(d => console.log('First time status:', d))
   
   // If it shows isFirstTime: false, reset the backend
   fetch('https://releye.boestad.com/api/auth/reset-all', {
     method: 'POST',
     headers: {'Content-Type': 'application/json'},
     credentials: 'include'
   })
     .then(r => r.json())
     .then(d => console.log('Reset result:', d))
   ```

4. **After the reset completes, navigate to:**
   ```
   https://releye.boestad.com/?reset=true
   ```

### Step 4: Verify Backend is Working

The diagnostics tool runs these checks:

1. **Backend Health Check**
   ```bash
   GET https://releye.boestad.com/api/health
   ```
   Should return: `{ success: true, data: { status: "ok", database: "mysql" } }`

2. **First-Time Status Check**
   ```bash
   GET https://releye.boestad.com/api/auth/first-time
   ```
   Should return: `{ success: true, data: { isFirstTime: true } }` (after reset)

3. **Reset Endpoint**
   ```bash
   POST https://releye.boestad.com/api/auth/reset-all
   ```
   Should return: `{ success: true, message: "All data reset" }`

## URL Parameters

The app now supports special URL parameters:

### `?reset=true`
Forces the app to clear the session and show first-time setup:
```
https://releye.boestad.com/?reset=true
```

### `?diagnostics=true`
Shows the diagnostics dashboard:
```
https://releye.boestad.com/?diagnostics=true
```

### `?invite=TOKEN&email=EMAIL`
Used for accepting user invitations (generated by admin):
```
https://releye.boestad.com/?invite=invite-123456&email=user@example.com
```

## Reset Tools Available

### 1. reset.html
Located at: `https://releye.boestad.com/reset.html`

- Guided 3-step reset process
- Warnings and confirmations
- Calls backend API to reset database
- Redirects to `/?reset=true` when complete

### 2. test-backend.html
Located at: `https://releye.boestad.com/test-backend.html`

- Comprehensive backend testing tool
- Check backend health
- Check first-time status
- Reset database
- View/clear localStorage
- Complete reset & restart

### 3. In-App Diagnostics
Located at: `https://releye.boestad.com/?diagnostics=true`

- React-based diagnostic component
- Real-time status checks
- Clear session and reload
- Detailed error messages

## Common Issues & Fixes

### Issue: "Setup failed - failed to set key"
**Cause:** Backend database connection failed
**Fix:** 
1. Check backend is running at https://releye.boestad.com/api
2. Check MySQL database credentials
3. Verify CORS headers are set correctly

### Issue: Still shows login after reset
**Cause:** Backend API returning `isFirstTime: false`
**Fix:**
1. Run diagnostics: `/?diagnostics=true`
2. Check if backend reset actually deleted users
3. Manually call reset endpoint from DevTools
4. Use `/?reset=true` to force first-time setup

### Issue: "Invalid invite token" when accepting invitation
**Cause:** Invite expired or was revoked
**Fix:**
1. Contact admin to send new invitation
2. Don't click "Back to Login" - it won't work
3. Navigate to main site: `https://releye.boestad.com`

### Issue: Can't connect to backend API
**Cause:** Backend server is down or DNS issue
**Fix:**
1. Verify https://releye.boestad.com/api/health returns 200 OK
2. Check DNS points to correct server (not GitHub Pages)
3. Verify backend server is running
4. Check CORS configuration allows origin

## Backend Requirements

For the authentication system to work properly, you need:

1. **MySQL Database** running and accessible
2. **Backend API Server** running at `https://releye.boestad.com/api`
3. **CORS Headers** properly configured:
   ```
   Access-Control-Allow-Origin: https://releye.boestad.com
   Access-Control-Allow-Credentials: true
   ```
4. **Endpoints Working:**
   - GET `/api/health`
   - GET `/api/auth/first-time`
   - POST `/api/auth/reset-all`
   - POST `/api/auth/login`
   - POST `/api/users`
   - GET `/api/users`

## Testing the System

After reset, the flow should be:

1. **Visit:** `https://releye.boestad.com`
2. **See:** First-Time Setup screen
3. **Create:** Admin account (username: admin, password: your-password)
4. **Redirect:** To file manager (ready to use app)

If any step fails, use the diagnostics tool to identify the issue.

## Emergency Reset Procedure

If nothing else works:

1. **Stop the backend server**
2. **Drop and recreate the MySQL database:**
   ```sql
   DROP DATABASE lpmjclyqtt_releye;
   CREATE DATABASE lpmjclyqtt_releye;
   ```
3. **Restart the backend server** (it will recreate tables)
4. **Clear browser storage:**
   - Open DevTools → Application → Storage → Clear site data
5. **Navigate to:** `https://releye.boestad.com/?reset=true`
6. **Create new admin account**

## Support & Debugging

If you continue to have issues:

1. **Check browser console** for error messages (F12 → Console)
2. **Run diagnostics** and save the output
3. **Check backend logs** for API errors
4. **Verify MySQL database** has the correct tables

The authentication system logs detailed information to the console with prefixes:
- `[App]` - Main application initialization
- `[UserRegistry]` - User management operations
- `[CloudAuthService]` - API calls to backend

Look for these logs to understand what's happening.
